<!DOCTYPE html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ebook reader</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;

      background-color: #000000;
      color: white;
    }

    #ebook-viewer {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 50%;
      overflow: hidden;
      z-index: -1;
      font-size: larger;
    }

    .button-bar {
      display: flex;
      flex-direction: column;
      height: 50%;
      width: 30px;
      position: fixed;
      right: 0;
      top: 0;
    }

    #completion-indicator {
      position: fixed;
      top: 0;
      right: 30px;
      background-color: black;
    }

    #integrated-japanese-dictionary-popup {
      box-sizing: border-box;
      position: fixed;
      top: 50%;
      left: 0px;
      width: 100%;
      height: 50%;
      border-top: solid 2px;
      border-left: 0;
      border-bottom: 0;
      border-right: 0;
      z-index: 2147483647;
      background-color: black;
    }
  </style>
</head>

<body>
  <div id="ebook-viewer" onclick="selectionChanged()">
    %EBOOK-TEXT%
  </div>
  <div class="button-bar">
    <button onclick="pageUp()" style="flex-grow: 1;">⇑</button>
    <button onclick="scrollUp()" style="flex-grow: 4;">↑</button>
    <button onclick="scrollDown()" style="flex-grow: 4;">↓</button>
    <button onclick="pageDown()" style="flex-grow: 1;">⇓</button>
  </div>
  <div id="completion-indicator">
  </div>
  <iframe id="integrated-japanese-dictionary-popup" src="DICTIONARY_IFRAME_URL">
  </iframe>

  <script>
    const popup = document.getElementById("integrated-japanese-dictionary-popup")
    const viewer = document.getElementById("ebook-viewer");
    const completionIndicator = document.getElementById("completion-indicator");

    function pageUp() {
      viewer.scrollBy({ top: -200, left: 0 });
      updateCompletionIndictator();
    }

    function scrollUp() {
      viewer.scrollBy({ top: -20, left: 0 });
      updateCompletionIndictator();
    }

    function scrollDown() {
      viewer.scrollBy({ top: 20, left: 0 });
      updateCompletionIndictator();
    }
    
    function pageDown() {
      viewer.scrollBy({ top: 200, left: 0 });
      updateCompletionIndictator();
    }

    function updateCompletionIndictator() {
      completionIndicator.innerText = Math.round((viewer.scrollTop / viewer.scrollHeight) * 1000, 1) / 10 + "%"
    }

    function selectionChanged() {
      const selection = window.getSelection();

      let text = selection.anchorNode.textContent;
      let offset = selection.anchorOffset;

      if (offset > 50) {
        text = text.substring(offset - 25, offset + 25);
        offset = 25;
      } else {
        text = text.substring(0, 100);
      }

      popup.contentWindow.postMessage({ text, offset }, "DICTIONARY_IFRAME_URL")
    }

    viewer.addEventListener("keypress", (ev) => {
      console.log(ev)
    })

    updateCompletionIndictator()
  </script>
</body>

</html>